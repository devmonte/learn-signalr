<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
    <meta name="viewport" content="width=device-width">
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@3.3.7/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link href="css/site.css" rel="stylesheet" />
    <title>Po co komu SignalR?</title>
</head>
<body>

    <nav class="navbar navbar-light bg-primary">
        <a class="navbar-brand" href="https://docs.microsoft.com/en-us/aspnet/core/signalr/introduction?view=aspnetcore-2.2" style="color:white">Po co komu SignalR?</a>
    </nav>
    <div class="container" style="height: calc(100% - 110px);">
        <div class="row align-items-center">
            <div class="col-sm">
            </div>
            <div class="col-lg-8">

                <div class="container mt-5" id="loginContainer">
                    <form>
                        <div class="form-group">
                            <label for="exampleInputEmail1">User name</label>
                            <input type="text" class="form-control" id="userName" aria-describedby="userNameHelp" placeholder="Enter your name">
                            <small id="userNameHelp" class="form-text text-muted">Don't be shy!</small>
                        </div>
                        <div class="form-group">
                            <label for="exampleInputPassword1">Password</label>
                            <input type="password" class="form-control" id="userPassword" placeholder="dotnet">
                        </div>
                        <button type="submit" class="btn btn-primary align-middle" id="loginBtn">Sign in</button>
                    </form>
                </div>

                <div class="container mt-5" id="conversationContainer" style="display:none">
                    <div id="messages" style="background-color: white; "></div>
                    <div style="width: 100%; border-left-style: ridge; border-right-style: ridge;">
                        <textarea id="message"
                                  style="width: 100%; padding: 5px 10px; border-style: hidden;"
                                  placeholder="Type message and press Enter to send..."></textarea>
                    </div>
                    <div style="overflow: auto; border-style: ridge; border-top-style: hidden;">
                        <button class="btn-success pull-right" id="sendmessage">Send</button>
                    </div>
                </div>

            </div>
            <div class="col-sm">
            </div>
        </div>
    </div>
    <div class="modal alert alert-danger fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <div>Connection Error...</div>
                    <div><strong style="font-size: 1.5em;">Hit Refresh/F5</strong> to rejoin. ;)</div>
                </div>
            </div>
        </div>
    </div>

    <script type="text/javascript" src="/lib/signalr.js"></script>
    <script type="text/javascript">
        document.addEventListener('DOMContentLoaded', function () {

            var userName = "";
            document.getElementById("userName").value = Math.random().toString(36).substring(2, 10);

            function createMessageEntry(encodedName, encodedMsg) {
                var entry = document.createElement('div');
                entry.classList.add("message-entry");
                if (encodedName === userName) {
                    entry.innerHTML = `<div class="message-avatar pull-right">${encodedName}</div>` +
                        `<div class="message-content pull-right">${encodedMsg}<div>`;
                } else {
                    entry.innerHTML = `<div class="message-avatar pull-left">${encodedName}</div>` +
                        `<div class="message-content pull-left">${encodedMsg}<div>`;
                }
                return entry;
            }

            function bindConnectionMessage(connection) {

                var messageCallback = function (messageDto) {
                    if (!messageDto) return;

                    var encodedName = messageDto.user;
                    var encodedMsg = messageDto.message.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;");
                    var messageEntry = createMessageEntry(encodedName, encodedMsg);

                    var messageBox = document.getElementById('messages');
                    messageBox.appendChild(messageEntry);
                    messageBox.scrollTop = messageBox.scrollHeight;
                };

                var notificationCallback = function (notification) {
                    if (!notification) return;

                    var entry = document.createElement('div');
                    entry.classList.add("message-entry");
                    entry.innerHTML = notification.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;");;
                    entry.classList.add("text-center");
                    entry.classList.add("system-message");

                    var messageBox = document.getElementById('messages');
                    messageBox.appendChild(entry);
                    messageBox.scrollTop = messageBox.scrollHeight;
                }

                connection.on('receiveMessage', messageCallback);
                connection.on('receiveNotification', notificationCallback);
                connection.onclose(onConnectionError);
            }

            function onConnected(connection) {
                console.log('connection started');
                document.getElementById("conversationContainer").style.display = "block";
                var messageInput = document.getElementById('message');
                messageInput.focus();

                document.getElementById('sendmessage').addEventListener('click', function (event) {
                    if (messageInput.value) {
                        connection.send('sendMessage', { User: userName, Message: messageInput.value });
                    }

                    messageInput.value = '';
                    messageInput.focus();
                    event.preventDefault();
                });
                document.getElementById('message').addEventListener('keypress', function (event) {
                    if (event.keyCode === 13) {
                        event.preventDefault();
                        document.getElementById('sendmessage').click();
                        return false;
                    }
                });
            }

            function onConnectionError(error) {
                if (error && error.message) {
                    console.error(error.message);
                }
                var modal = document.getElementById('myModal');
                modal.classList.add('in');
                modal.style = 'display: block;';
            }

            function startConnection(token) {
                var connection = new signalR.HubConnectionBuilder()
                    .withUrl('https://advchat.azurewebsites.net/chatHub', { accessTokenFactory: () => token })
                    .build();
                bindConnectionMessage(connection);
                connection.start()
                    .then(function () {
                        onConnected(connection);
                    })
                    .catch(function (error) {
                        console.error(error.message);
                    });
            }

            function getToken() {
                console.log("sending request for Token!");

                userName = document.getElementById("userName").value
                var password = document.getElementById("userPassword").value;
                var user = { Name: userName, Password: password };

                var xhttp;
                xhttp = new XMLHttpRequest();
                xhttp.onreadystatechange = function () {
                    if (this.readyState == 4 && this.status == 200) {
                        console.log(xhttp.response);
                        document.getElementById("loginContainer").style.display = "none";
                        startConnection(xhttp.response);
                    }
                };
                
                xhttp.open("POST", "https://advchat.azurewebsites.net/api/auth", true);
                xhttp.setRequestHeader('Access-Control-Allow-Origin', '*');
                xhttp.setRequestHeader('Content-Type', 'application/json');
                xhttp.send(JSON.stringify(user));
            }

            document.getElementById("loginBtn").addEventListener("click", function (event) {
                event.preventDefault();
                getToken();
            });

        });
    </script>
</body>
</html>